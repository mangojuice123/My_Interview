- [常规状态转换](#常规状态转换)
- [常见问题](#常见问题)
  - [TCP 为什么不是两次握手建立连接？](#tcp-为什么不是两次握手建立连接)
  - [TCP 为什么不是四次握手建立连接？](#tcp-为什么不是四次握手建立连接)
  - [TCP 为什么需要四次挥手关闭连接？](#tcp-为什么需要四次挥手关闭连接)
  - [TIME_WAIT = 2 MSL(Maximum Segment Lifetime)](#time_wait--2-mslmaximum-segment-lifetime)

</br></br>

# 常规状态转换
![状态转换](https://pic2.zhimg.com/80/ab46c8eb523f3f7686bc72fa23c82cc7_720w.jpg?source=1940ef5c)

# 常见问题
## TCP 为什么不是两次握手建立连接？
答：
- 这个问题的本质是，信道不可靠，但是通信双发需要就某个问题（ISN）达成一致。而要解决这个问题，无论你在消息中包含什么信息，三次通信是理论上的最小值。
- 假设有 A、B 两个结点，只使用两次握手的情况下，A 可以确认 B 的接收、发送能力正常，B 可以确认 A 的发送能力正常，但是 B 无法确认 A 的接收能力是否正常。
  - 假如二者通信过程中只有 A 向 B 发送数据，而没有 B 向 A 发送数据，那么两次握手可以达到稳定发送数据的目的。
- 在实际的 TCP 实现中，TCP 连接握手确认的最重要的信息是，通信双方数据原点的序列号，即 `ISN = Initial Sequence Number`。
- 两次握手通信过程模拟
    1. `A ---> SYN + A's ISN ----> B`
    2. `B ---> SYN + B's ISN + B's ACK ----> A`
    3. 此时如果 B 发给 A 的信息丢失，那么 A 和 B 就 B 的初始序列号无法达成一致，不应该在此时传输数据，连接建立失败。但是在 B 的视角中，连接已经单方面建立起来，会造成资源浪费。

## TCP 为什么不是四次握手建立连接？
答：
1. `A ---> SYN + A's ISN ----> B`
2. `B ---> B's ACK ----> A`
3. `B ---> SYN + B's ISN ----> A`
4. `A ---> A's ACK ----> B`
- 显然 3 4 这两个步骤可以合并，类似的还有四挥手，`FIN + ACK` 合并提升效率。

## TCP 为什么需要四次挥手关闭连接？
- 由于 TCP 的半关闭（half-close）特性，TCP 提供了连接的一端在结束它的发送后还能接收来自另一端数据的能力。
- 任何一方都可以在数据传送结束后发出连接释放的通知，待对方确认后进入半关闭状态。当另一方也没有数据再发送的时候，则发出连接释放通知，对方确认后就完全关闭了 TCP 连接。
- 即两次握手就可以释放一端到另一端的 TCP 连接，完全释放连接一共需要四次握手。

## TIME_WAIT = 2 MSL(Maximum Segment Lifetime)
- 确保连接被可靠地关闭（根据两军问题，实际上不管怎样都无法完全保证连接被可靠地关闭）
- 处理延迟的重复报文，避免前一个连接的报文干扰后一个连接（最重要的原因）
  - 第一个 MSL 确保自己发送的最后一个 ACK 在网络中消失
  - 第二个 MSL 确保对方可能收到 ACK 之前重传的 FIN 在网络中消失
- 2 MSL 的前提：网络丢包不太严重。试想，如果 A 发出的最后一个 ACK 包丢失，并且紧接着 B 在 1 MSL 的最后时间重传 FIN 包并且丢失，依然会造成连接无法正确关闭的情况（[Two General's Problem](https://en.wikipedia.org/wiki/Two_Generals%27_Problem)）。但是这种连续丢失两个包的情况发生概率实在太低，2 MSL 的设置更具有性价比。