- [常见问题](#常见问题)
  - [什么是数据库的水平拆分、垂直拆分？](#什么是数据库的水平拆分垂直拆分)
  - [数据库慢查询如何优化？](#数据库慢查询如何优化)
- [公司](#公司)


</br></br>

![主从复制](https://pic2.zhimg.com/80/v2-92c37e8a96eaf4535fdf9533ffaadf8a_720w.png)

# 常见问题
## 什么是数据库的水平拆分、垂直拆分？
答：
- 水平拆分：将一张表的数据拆分到多个表中。这样每张表的表结构是相同的，但是数据不同。
    - 拆分方式：
        1. **主键取模处理**（对数据库的更新必须也进行取模，计算出需要写入的是哪张表）
        2. 通过时间分表（每月生成新的表）
        3. 通过范围分表（超过一定数据量即分表）
    - 分表后，查询会比以前复杂，通常不建议 `join`，一般的做法是两次查询。
- 垂直拆分：将一张表的字段拆分为主表以及扩展表，使用频次较高的字段在一张表，其余的在一张表。
    - 多表查询不建议使用 `join`，使用两次查询。
- 拆分带来的问题：事务如何保证？
  - 最终一致性方案：业务 A 调用 B，两个执行成果才算最终成功。B 失败时，通过 MQ 将消息告诉 A，A 进行回滚（A 的回滚必须是幂等的，否则 B 重复发消息会带来问题）。
  

## 数据库慢查询如何优化？
答：
1. 通过慢查询日志（slow log）定位需要优化的 SQL 语句（或者设置 `SQL_NO_CACHE` 运行测试）；
2. 找出区分度最高的字段；
3. `explain` 查看执行计划；
  - `rows` 是核心指标：绝大部分行数少的 SQL 语句一定执行得很快（有例外），优化语句主要在于优化 `rows`；
  - `type`
    - ALL：全表扫描；
    - index：需要扫描索引树上的全部数据，仅比全表扫描快一点；
    - ref：命中普通索引，每一次匹配可能有多行数据返回；
    - eq_ref：命中 PK 或非空唯一索引；
  - `extra`
    - Using index：覆盖索引，不需要回表；
4. 根据加索引的原则加索引（加了索引效果不一定好）；
5. 测试，观察效果。

</br></br>


# 公司
- 2021-11 小米